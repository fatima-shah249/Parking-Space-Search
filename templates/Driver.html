{% extends "base.html" %}
{% block title %}Find Nearby Parking{% endblock %}

{% block content %}
<div class="bg-white rounded-xl shadow-md p-6 mb-6">
    <h1 class="text-3xl font-bold text-gray-900 mb-2 text-center">Nearby Parking Zones</h1>
    <p class="text-gray-600 text-center mb-4">Click any parking icon for details or search for a location</p>
    <div class="text-center bg-gray-100 p-4 rounded-lg shadow">
        <strong class="text-gray-800">üìç Your Current Location:</strong>
        <p class="text-gray-600 mt-1">{{ User_location }}</p>
    </div>
</div>

<div class="flex flex-col md:flex-row gap-4">
    <div class="relative w-full md:w-2/3">
        <input id="pac-input" class="absolute top-3 left-1/2 -translate-x-1/2 z-10 w-3/4 md:w-1/2 p-2 rounded-md shadow-lg focus:outline-none" type="text" placeholder="Search for a location"/>
        <div id="map" class="w-full h-[600px] rounded-xl shadow-md"></div>
    </div>
    
    <div id="directions-panel" class="w-full md:w-1/3 h-[600px] overflow-y-auto bg-gray-50 p-4 rounded-xl shadow-md">
        <p class="text-gray-500">Route details will appear here.</p>
    </div>
</div>


<script>
// --- 1. Global Variables ---
let map;
let directionsService;
let directionsRenderer;
let infoWindow;
let searchMarker; // ‚úÖ ADDED: To hold the marker for the searched location
const userLocation = { lat: {{ lat }}, lng: {{ lng }} };

function initMap() {
    // --- 2. Initialize Map and Services ---
    map = new google.maps.Map(document.getElementById("map"), {
        center: userLocation,
        zoom: 14,
        // Disabling the default UI to have a cleaner search experience
        disableDefaultUI: true,
        zoomControl: true,
    });

    directionsService = new google.maps.DirectionsService();
    directionsRenderer = new google.maps.DirectionsRenderer();
    infoWindow = new google.maps.InfoWindow();

    directionsRenderer.setMap(map);
    directionsRenderer.setPanel(document.getElementById("directions-panel"));

    // --- 3. User's Location Marker ---
    new google.maps.Marker({
        position: userLocation,
        map,
        title: "You are here",
        icon: {
            path: google.maps.SymbolPath.CIRCLE,
            scale: 8,
            fillColor: "#4285F4",
            fillOpacity: 1,
            strokeWeight: 2,
            strokeColor: "white"
        },
        zIndex: 999
    });

    // --- 4. Initialize Search Bar ---
    const input = document.getElementById("pac-input");
    const autocomplete = new google.maps.places.Autocomplete(input);
    autocomplete.bindTo("bounds", map); // Bias search results to the map's viewport

    // Create a single marker for the search result (we'll move it as needed)
    searchMarker = new google.maps.Marker({
        map,
        anchorPoint: new google.maps.Point(0, -29), // Position the InfoWindow correctly
    });
    searchMarker.setVisible(false); // Hide it until a search is made

    autocomplete.addListener("place_changed", () => {
        searchMarker.setVisible(false);
        const place = autocomplete.getPlace();

        if (!place.geometry || !place.geometry.location) {
            window.alert("No details available for input: '" + place.name + "'");
            return;
        }

        // If the place has a geometry, then present it on a map.
        if (place.geometry.viewport) {
            map.fitBounds(place.geometry.viewport);
        } else {
            map.setCenter(place.geometry.location);
            map.setZoom(17);
        }
        searchMarker.setPosition(place.geometry.location);
        searchMarker.setVisible(true);

        // Optional: Show an InfoWindow on the search marker
        infoWindow.setContent(`<div><strong>${place.name}</strong><br>${place.formatted_address}</div>`);
        infoWindow.open(map, searchMarker);
    });

    // --- 5. Parking Zone Markers ---
    const nearbySlots = {{ slots|tojson }};
    nearbySlots.forEach((slot, index) => {
        // ... (The rest of your parking zone marker code is unchanged)
        const slotPosition = { lat: parseFloat(slot.latitude), lng: parseFloat(slot.longitude) };
        const marker = new google.maps.Marker({
            position: slotPosition,
            map,
            title: slot.location,
            label: (index + 1).toString(), 
        });
        marker.addListener("click", () => {
            const contentString = `
              <div class="p-2 font-sans" style="max-width: 250px;">
                <h3 class="text-lg font-bold text-gray-800">${slot.location}</h3>
                <div class="text-gray-600 mt-2">
                  <p><strong>Available Slots:</strong> <span class="font-semibold text-green-600">${slot.available_slots}</span></p>
                  <p><strong>Parking Fee:</strong> <span class="font-semibold text-gray-800">‚Çπ40</span></p>
                </div>
                <div class="flex gap-2 mt-4">
                  <button onclick="getDirections(${slot.latitude}, ${slot.longitude})" class="w-full px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700">Directions</button>
                  <button onclick="proceedToPay(${slot.slot_id})" class="w-full px-4 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700">Pay Now</button>
                </div>
              </div>
            `;
            infoWindow.setContent(contentString);
            infoWindow.open(map, marker);
        });
    });
}

// ... (The rest of your functions: getDirections, proceedToPay, etc., are unchanged)
function getDirections(lat, lng) {
    const destination = { lat: lat, lng: lng };
    calculateAndDisplayRoute(destination);
    infoWindow.close(); 
}
function proceedToPay(slotId) {
    infoWindow.close();
    const paymentAmount = 40.00; 
    fetch('/create_order', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ amount: paymentAmount, vehicle: 'car' })
    })
    .then(response => response.json())
    .then(data => {
        const options = {
            key: data.key_id,
            amount: data.amount,
            currency: data.currency,
            name: "Smart Parking System",
            description: `Payment for Slot ID: ${slotId}`,
            order_id: data.order_id,
            handler: function (response){ alert('Payment successful! Payment ID: ' + response.razorpay_payment_id); },
            prefill: { name: "Test User", email: "test.user@example.com", contact: "9999999999" },
            notes: { slot_id: slotId },
            theme: { color: "#3399cc" }
        };
        const rzp1 = new Razorpay(options);
        rzp1.on('payment.failed', function (response){ alert('Payment failed! Error: ' + response.error.description); });
        rzp1.open();
    })
    .catch(error => console.error('Error:', error));
}
function calculateAndDisplayRoute(destination) {
    document.getElementById("directions-panel").innerHTML = "";
    directionsService.route({
        origin: userLocation,
        destination: destination,
        travelMode: google.maps.TravelMode.DRIVING
    }, (response, status) => {
        if (status === "OK") {
            directionsRenderer.setDirections(response);
        } else {
            window.alert("Directions request failed due to " + status);
        }
    });
}
</script>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script async defer
    src="https://maps.googleapis.com/maps/api/js?key={{ api_key }}&libraries=places&callback=initMap">
</script>
{% endblock %}
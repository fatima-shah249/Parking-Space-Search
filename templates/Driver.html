{% extends "base.html" %}
{% block title %}Find Nearby Parking{% endblock %}

{% block content %}
<div class="bg-white rounded-xl shadow-md p-6 mb-6">
    <h1 class="text-3xl font-bold text-gray-900 mb-2 text-center">Nearby Parking Zones</h1>
    <p class="text-gray-600 text-center mb-4">Click any parking icon to get directions</p>
    <div class="text-center bg-gray-100 p-4 rounded-lg shadow">
        <strong class="text-gray-800">üìç Your Current Location:</strong>
        <p class="text-gray-600 mt-1">{{ User_location }}</p>
    </div>
</div>

<div id="map" class="w-full h-[600px] rounded-xl shadow-md"></div>

<script>
function initMap() {
    const userLocation = { lat: {{ lat }}, lng: {{ lng }} };

    const map = new google.maps.Map(document.getElementById("map"), {
        center: userLocation,
        zoom: 14,
    });

    // --- User's Location Marker ---
    new google.maps.Marker({
        position: userLocation,
        map,
        title: "You are here",
        icon: {
            url: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png" // A distinct blue marker for the user
        }
    });

    // --- Parking Zone Markers ---
    const nearbySlots = {{ slots|tojson }};
    
    nearbySlots.forEach(slot => {
        const slotPosition = { lat: parseFloat(slot.latitude), lng: parseFloat(slot.longitude) };

        // Create a marker for each parking slot
        const marker = new google.maps.Marker({
            position: slotPosition,
            map,
            title: `${slot.location}\nAvailable: ${slot.available_slots}\nClick for directions`,
        });

        // ‚úÖ ADDED: Click listener for each marker
        marker.addListener("click", () => {
            // Construct the Google Maps directions URL
            const directionsUrl = `https://www.google.com/maps/dir/?api=1&origin=${userLocation.lat},${userLocation.lng}&destination=${slotPosition.lat},${slotPosition.lng}`;
            
            // Open the URL in a new tab
            window.open(directionsUrl, "_blank");
        });
    });
}
</script>

<script async defer
    src="https://maps.googleapis.com/maps/api/js?key={{ api_key }}&callback=initMap">
</script>
{% endblock %}
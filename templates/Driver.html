{% extends "base.html" %}
{% block title %}Find Nearby Parking{% endblock %}


{% block content %}
<div class="bg-white rounded-xl shadow-md p-6 mb-6">
  <h1 class="text-3xl font-bold text-gray-900 mb-2 text-center">Nearby Parking Zones</h1>
  <p class="text-gray-600 text-center mb-4">Click any parking icon for details or search for a location</p>
  <div class="text-center bg-gray-100 p-4 rounded-lg shadow">
    <strong class="text-gray-800">Your Current Location:</strong>
    <p class="text-gray-600 mt-1">{{ User_location }}</p>
  </div>
  <form action="{{ url_for('Driver') }}" method="POST" class="mt-4 w-full md:w-3/4 lg:w-1/2 mx-auto">
  <label for="radius-input" class="block text-sm font-medium text-gray-700 mb-1">Show within (meters):</label>
  <div class="flex gap-2">
    <input type="number" id="radius-input" 
           name="radius_meters" step="100"
           class="flex-grow p-2 rounded-md shadow-sm border border-gray-300 text-center focus:outline-none focus:ring-blue-500 focus:border-blue-500">
    <button type="submit" class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75">
      Search
    </button>
  </div>
  </form>
</div>
</div>

 <div class="bg-gray-100 p-3 rounded-md shadow-sm text-sm flex items-center gap-3 md:mt-6">
        <div class="flex items-center gap-1">
          <span class="inline-block w-3 h-3 rounded-full bg-green-500"></span>
          <span>Civilian Zone</span>
        </div>
        <div class="flex items-center gap-1">
          <span class="inline-block w-3 h-3 rounded-full bg-red-500"></span>
          <span>General Zone</span>
        </div>
      </div>
  </div>
  </div>
  
<div class="flex flex-col md:flex-row gap-4">
  <div class="relative w-full md:w-2/3">
    <input id="pac-input"
      class="absolute top-3 left-1/2 -translate-x-1/2 z-10 w-3/4 md:w-1/2 p-2 rounded-md shadow-lg focus:outline-none"
      type="text" placeholder="Search for a location" />
    <div id="map" class="w-full h-[600px] rounded-xl shadow-md"></div>
  </div>

  <div id="directions-panel" class="w-full md:w-1/3 h-[600px] overflow-y-auto bg-gray-50 p-4 rounded-xl shadow-md">
    <p class="text-gray-500">Route details will appear here.</p>
  </div>
</div>

<script>
let map, directionsService, directionsRenderer, infoWindow;
let searchMarker, userMarker;
const userLocation = { lat: {{ lat }}, lng: {{ lng }} };

function initMap() {
  map = new google.maps.Map(document.getElementById("map"), {
    center: userLocation,
    zoom: 14,
    disableDefaultUI: true,
    zoomControl: true,
  });

  directionsService = new google.maps.DirectionsService();
  directionsRenderer = new google.maps.DirectionsRenderer();
  infoWindow = new google.maps.InfoWindow();
  directionsRenderer.setMap(map);
  directionsRenderer.setPanel(document.getElementById("directions-panel"));

  // --- User Marker ---
  userMarker = new google.maps.Marker({
    position: userLocation,
    map,
    title: "You are here",
    icon: {
      path: google.maps.SymbolPath.CIRCLE,
      scale: 8,
      fillColor: "#4285F4",
      fillOpacity: 1,
      strokeWeight: 2,
      strokeColor: "white"
    },
    zIndex: 999
  });

  // --- Search Bar ---
  const input = document.getElementById("pac-input");
  const autocomplete = new google.maps.places.Autocomplete(input);
  autocomplete.bindTo("bounds", map);
  searchMarker = new google.maps.Marker({ map, anchorPoint: new google.maps.Point(0, -29) });
  searchMarker.setVisible(false);

  autocomplete.addListener("place_changed", () => {
    searchMarker.setVisible(false);
    const place = autocomplete.getPlace();
    if (!place.geometry || !place.geometry.location) {
      window.alert("No details available for input: '" + place.name + "'");
      return;
    }
    if (place.geometry.viewport) map.fitBounds(place.geometry.viewport);
    else {
      map.setCenter(place.geometry.location);
      map.setZoom(17);
    }
    searchMarker.setPosition(place.geometry.location);
    searchMarker.setVisible(true);
    infoWindow.setContent(`<div><strong>${place.name}</strong><br>${place.formatted_address}</div>`);
    infoWindow.open(map, searchMarker);
  });

  // --- Parking Zone Markers ---
const nearbySlots = {{ slots | tojson }};
nearbySlots.forEach((slot, index) => {
  const slotPosition = { lat: parseFloat(slot.latitude), lng: parseFloat(slot.longitude) };
  const fillColor = (slot.civilian_zone && slot.civilian_zone.toLowerCase() === "yes")
    ? "rgb(0,255, 0)" // Green for civilian zones
    : "rgb(255, 0, 0)"; // Red for others

  // Custom SVG pin icon
  const svgMarker = {
    path: "M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5S10.62 6.5 12 6.5s2.5 1.12 2.5 2.5S13.38 11.5 12 11.5z",
    fillColor: fillColor,
    fillOpacity: 1,
    strokeColor: "#FFFFFF",
    strokeWeight: 2,
    scale: 1.6,
    anchor: new google.maps.Point(12, 24),
    labelOrigin: new google.maps.Point(12, 10)
  };

  const marker = new google.maps.Marker({
    position: slotPosition,
    map,
    title: slot.location || "Unknown Location",
    icon: svgMarker,
    label: {
      text: (index + 1).toString(),
      color: "#000000",
      fontSize: "13px",
      fontWeight: "bold"
    },
    zIndex: 2
  });

  marker.addListener("click", () => {
    const contentString = `
      <div class="p-2 font-sans" style="max-width: 250px;">
        <h3 class="text-lg font-bold text-gray-800">${slot.location}</h3>
        <div class="text-gray-600 mt-2">
          <p><strong>Available Slots:</strong> <span class="font-semibold text-green-600">${slot.available_slots}</span></p>
          <p><strong>Civilian Zone:</strong> <span class="font-semibold">${slot.civilian_zone}</span></p>
          <p><strong>Parking Fee:</strong> <span class="font-semibold text-gray-800">â‚¹40</span></p>
        </div>
        <div class="flex gap-2 mt-4">
          <button onclick="getDirections(${slot.latitude}, ${slot.longitude})"
            class="w-full px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700">
            Directions
          </button>
          <button onclick="proceedToPay(${slot.slot_id})"
            class="w-full px-4 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700">
            Pay Now
          </button>
        </div>
      </div>`;
    infoWindow.setContent(contentString);
    infoWindow.open(map, marker);
  });
});

  // --- Auto Update Location ---
  async function fetchAndUpdateUserLocation() {
    try {
      const response = await fetch("/get_latest_location");
      const data = await response.json();
      if (data.lat && data.lng) {
        const newLatLng = new google.maps.LatLng(data.lat, data.lng);
        userMarker.setPosition(newLatLng);
        map.panTo(newLatLng);
      }
    } catch (error) {
      console.error("Error fetching latest ESP location:", error);
    }
  }

  setInterval(fetchAndUpdateUserLocation, 5000);

  // --- Directions Function ---
  window.getDirections = function(lat, lng) {
    const destination = { lat: lat, lng: lng };
    directionsService.route({
      origin: userMarker.getPosition(),
      destination: destination,
      travelMode: google.maps.TravelMode.DRIVING
    }, (response, status) => {
      if (status === "OK") {
        directionsRenderer.setDirections(response);
      } else {
        window.alert("Directions request failed due to " + status);
      }
    });
  };

  // --- Payment Integration ---
  window.proceedToPay = function(slotId) {
    const paymentAmount = 40.00;
    fetch('/create_order', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ amount: paymentAmount, vehicle: 'car' })
    })
    .then(response => response.json())
    .then(data => {
      const options = {
        key: data.key_id,
        amount: data.amount,
        currency: data.currency,
        name: "Smart Parking System",
        description: `Payment for Slot ID: ${slotId}`,
        order_id: data.order_id,
        handler: function (response) {
          alert('Payment successful! Payment ID: ' + response.razorpay_payment_id);
        },
        prefill: { name: "Test User", email: "test.user@example.com", contact: "9999999999" },
        notes: { slot_id: slotId },
        theme: { color: "#3399cc" }
      };
      const rzp1 = new Razorpay(options);
      rzp1.on('payment.failed', function (response) {
        alert('Payment failed! Error: ' + response.error.description);
      });
      rzp1.open();
    })
    .catch(error => console.error('Error:', error));
  };
}
</script>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script async defer src="https://maps.googleapis.com/maps/api/js?key={{ api_key }}&libraries=places&callback=initMap"></script>
{% endblock %} to right side of this search bar i need to add green is civilian_parking zone and red are normal zones but normal zones are is right word
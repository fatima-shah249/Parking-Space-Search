{% extends "base.html" %}
{% block title %}Find Nearby Parking{% endblock %}

{% block content %}
<div class="bg-white rounded-xl shadow-md p-6 mb-6">
    <h1 class="text-3xl font-bold text-gray-900 mb-2 text-center">Nearby Parking Zones</h1>
    <p class="text-gray-600 text-center mb-4">Click any parking icon for details and directions</p>
    <div class="text-center bg-gray-100 p-4 rounded-lg shadow">
        <strong class="text-gray-800">üìç Your Current Location:</strong>
        <p class="text-gray-600 mt-1">{{ User_location }}</p>
    </div>
</div>

<div class="flex flex-col md:flex-row gap-4">
    <div id="map" class="w-full md:w-2/3 h-[600px] rounded-xl shadow-md"></div>
    
    <div id="directions-panel" class="w-full md:w-1/3 h-[600px] overflow-y-auto bg-gray-50 p-4 rounded-xl shadow-md">
        <p class="text-gray-500">Route details will appear here.</p>
    </div>
</div>


<script>
// --- 1. Global Variables ---
let map;
let directionsService;
let directionsRenderer;
let infoWindow; // ‚úÖ ADDED: To hold the pop-up dialog box
const userLocation = { lat: {{ lat }}, lng: {{ lng }} };

function initMap() {
    // --- 2. Initialize Map and Services ---
    map = new google.maps.Map(document.getElementById("map"), {
        center: userLocation,
        zoom: 14,
    });

    directionsService = new google.maps.DirectionsService();
    directionsRenderer = new google.maps.DirectionsRenderer();
    infoWindow = new google.maps.InfoWindow(); // ‚úÖ ADDED: Initialize the InfoWindow

    directionsRenderer.setMap(map);
    directionsRenderer.setPanel(document.getElementById("directions-panel"));

    // --- 3. User's Location Marker ---
    new google.maps.Marker({
        position: userLocation,
        map,
        title: "You are here",
        icon: {
            url: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png"
        }
    });

    // --- 4. Parking Zone Markers ---
    const nearbySlots = {{ slots|tojson }};
    
    nearbySlots.forEach(slot => {
        const slotPosition = { lat: parseFloat(slot.latitude), lng: parseFloat(slot.longitude) };

        const marker = new google.maps.Marker({
            position: slotPosition,
            map,
            title: slot.location,
        });

        // ‚úÖ MODIFIED: The click listener now opens the InfoWindow
        marker.addListener("click", () => {
            // Create the HTML content for the dialog box
            const contentString = `
              <div class="p-2 font-sans" style="max-width: 250px;">
                <h3 class="text-lg font-bold text-gray-800">${slot.location}</h3>
                <div class="text-gray-600 mt-2">
                  <p><strong>Available Slots:</strong> <span class="font-semibold text-green-600">${slot.available_slots}</span></p>
                  <p><strong>Occupied Slots:</strong> <span class="font-semibold text-red-600">${slot.occupied_slots}</span></p>
                </div>
                <button
                  onclick="getDirections(${slot.latitude}, ${slot.longitude})"
                  class="mt-4 w-full px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-opacity-75"
                >
                  Get Directions
                </button>
              </div>
            `;
            
            infoWindow.setContent(contentString);
            infoWindow.open(map, marker);
        });
    });
}

// --- 5. New function to be called from the InfoWindow button ---
function getDirections(lat, lng) {
    const destination = { lat: lat, lng: lng };
    calculateAndDisplayRoute(destination);
    infoWindow.close(); // Close the dialog box after the button is clicked
}

// --- 6. Function to Calculate and Display the Route (Unchanged) ---
function calculateAndDisplayRoute(destination) {
    // Clear previous directions from the panel
    document.getElementById("directions-panel").innerHTML = "";

    directionsService.route({
        origin: userLocation,
        destination: destination,
        travelMode: google.maps.TravelMode.DRIVING
    }, (response, status) => {
        if (status === "OK") {
            directionsRenderer.setDirections(response);
        } else {
            window.alert("Directions request failed due to " + status);
        }
    });
}
</script>

<script async defer
    src="https://maps.googleapis.com/maps/api/js?key={{ api_key }}&callback=initMap">
</script>
{% endblock %}
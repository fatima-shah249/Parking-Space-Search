{% extends "base.html" %}
{% block title %}Find Nearby Parking{% endblock %}

{% block content %}
<div class="bg-white rounded-xl shadow-md p-6 mb-6">
    <h1 class="text-3xl font-bold text-gray-900 mb-2 text-center">Nearby Parking Zones</h1>
    <p class="text-gray-600 text-center mb-4">Click any parking icon for details and payment</p>
    <div class="text-center bg-gray-100 p-4 rounded-lg shadow">
        <strong class="text-gray-800">üìç Your Current Location:</strong>
        <p class="text-gray-600 mt-1">{{ User_location }}</p>
    </div>
</div>

<div class="flex flex-col md:flex-row gap-4">
    <div id="map" class="w-full md:w-2/3 h-[600px] rounded-xl shadow-md"></div>
    <div id="directions-panel" class="w-full md:w-1/3 h-[600px] overflow-y-auto bg-gray-50 p-4 rounded-xl shadow-md">
        <p class="text-gray-500">Route details will appear here.</p>
    </div>
</div>


<script>
// --- 1. Global Variables ---
let map;
let directionsService;
let directionsRenderer;
let infoWindow;
const userLocation = { lat: {{ lat }}, lng: {{ lng }} };

function initMap() {
    // --- 2. Initialize Map and Services ---
    map = new google.maps.Map(document.getElementById("map"), {
        center: userLocation,
        zoom: 14,
    });

    directionsService = new google.maps.DirectionsService();
    directionsRenderer = new google.maps.DirectionsRenderer();
    infoWindow = new google.maps.InfoWindow();

    directionsRenderer.setMap(map);
    directionsRenderer.setPanel(document.getElementById("directions-panel"));

    // --- 3. User's Location Marker (RELIABLE VERSION) ---
    new google.maps.Marker({
        position: userLocation,
        map,
        title: "You are here",
        // ‚úÖ Using an official Google Maps Symbol for a reliable blue circle
        icon: {
            path: google.maps.SymbolPath.CIRCLE,
            scale: 8,
            fillColor: "#4285F4", // Blue color
            fillOpacity: 1,
            strokeWeight: 2,
            strokeColor: "white"
        },
        zIndex: 999 // Ensure user marker is always on top
    });

    // --- 4. Parking Zone Markers ---
    const nearbySlots = {{ slots|tojson }};
    
    nearbySlots.forEach((slot, index) => {
        const slotPosition = { lat: parseFloat(slot.latitude), lng: parseFloat(slot.longitude) };

        const marker = new google.maps.Marker({
            position: slotPosition,
            map,
            title: slot.location,
            label: (index + 1).toString(), 
        });

        marker.addListener("click", () => {
            const contentString = `
              <div class="p-2 font-sans" style="max-width: 250px;">
                <h3 class="text-lg font-bold text-gray-800">${slot.location}</h3>
                <div class="text-gray-600 mt-2">
                  <p><strong>Available Slots:</strong> <span class="font-semibold text-green-600">${slot.available_slots}</span></p>
                  <p><strong>Parking Fee:</strong> <span class="font-semibold text-gray-800">‚Çπ40</span></p>
                </div>
                <button
                  onclick="proceedToPay(${slot.slot_id}, ${slot.latitude}, ${slot.longitude})"
                  class="mt-4 w-full px-4 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-400 focus:ring-opacity-75"
                >
                  Proceed to Pay
                </button>
              </div>
            `;
            
            infoWindow.setContent(contentString);
            infoWindow.open(map, marker);
        });
    });
}

// --- 5. New function to handle both directions and payment ---
function proceedToPay(slotId, lat, lng) {
    const destination = { lat: lat, lng: lng };
    
    calculateAndDisplayRoute(destination);
    infoWindow.close();

    const paymentAmount = 40.00; 

    fetch('/create_order', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ amount: paymentAmount, vehicle: 'car' })
    })
    .then(response => response.json())
    .then(data => {
        const options = {
            key: data.key_id,
            amount: data.amount,
            currency: data.currency,
            name: "Smart Parking System",
            description: `Payment for Slot ID: ${slotId}`,
            order_id: data.order_id,
            handler: function (response){
                alert('Payment successful! Payment ID: ' + response.razorpay_payment_id);
            },
            prefill: {
                name: "Test User",
                email: "test.user@example.com",
                contact: "9999999999"
            },
            notes: {
                slot_id: slotId
            },
            theme: {
                color: "#3399cc"
            }
        };
        const rzp1 = new Razorpay(options);
        rzp1.on('payment.failed', function (response){
            alert('Payment failed! Error: ' + response.error.description);
        });
        rzp1.open();
    })
    .catch(error => console.error('Error:', error));
}


// --- 6. Function to Calculate and Display the Route (Unchanged) ---
function calculateAndDisplayRoute(destination) {
    document.getElementById("directions-panel").innerHTML = "";
    directionsService.route({
        origin: userLocation,
        destination: destination,
        travelMode: google.maps.TravelMode.DRIVING
    }, (response, status) => {
        if (status === "OK") {
            directionsRenderer.setDirections(response);
        } else {
            window.alert("Directions request failed due to " + status);
        }
    });
}
</script>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script async defer
    src="https://maps.googleapis.com/maps/api/js?key={{ api_key }}&callback=initMap">
</script>
{% endblock %}